generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// SUPER ADMIN (App-level admin)
// ============================================
model SuperAdmin {
  id            String   @id @default(uuid())
  email         String   @unique
  password      String
  name          String
  isActive      Boolean  @default(true)
  lastLogin     DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  refreshTokens SuperAdminRefreshToken[]

  @@map("super_admins")
}

model SuperAdminRefreshToken {
  id           String      @id @default(uuid())
  superAdminId String
  token        String      @unique
  expiresAt    DateTime
  createdAt    DateTime    @default(now())

  superAdmin   SuperAdmin  @relation(fields: [superAdminId], references: [id], onDelete: Cascade)

  @@map("super_admin_refresh_tokens")
}


// ============================================
// MULTI-TENANCY CORE
// ============================================
model Tenant {
  id             String   @id @default(uuid())
  name           String
  subdomain      String   @unique // e.g., "acme" for acme.yourdomain.com
  email          String
  phone          String?
  logo           String?
  status         TenantStatus @default(ACTIVE)
  subscriptionTier String  @default("FREE") // FREE, BASIC, PREMIUM, ENTERPRISE
  maxEmployees   Int      @default(10)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organisations  Organisation[]
  users          User[]

  @@map("tenants")
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  INACTIVE
}

// ============================================
// ORGANISATION (Tenant can have multiple orgs)
// ============================================
model Organisation {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  code        String   // Unique org code like "HQ", "BRANCH1"
  address     String?
  city        String?
  state       String?
  country     String?
  zipCode     String?
  phone       String?
  email       String?
  logo        String?
  status      OrgStatus @default(ACTIVE)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employees   Employee[]
  departments Department[]

  @@unique([tenantId, code])
  @@map("organisations")
}

enum OrgStatus {
  ACTIVE
  INACTIVE
}

// ============================================
// USER AUTHENTICATION & RBAC
// ============================================
model User {
  id              String   @id @default(uuid())
  tenantId        String
  email           String   
  password        String
  role            UserRole @default(EMPLOYEE)
  isActive        Boolean  @default(true)
  lastLogin       DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employee        Employee?
  refreshTokens   RefreshToken[]

  @@unique([tenantId, email])
  @@map("users")
}

enum UserRole {
  SUPER_ADMIN      // App-level admin (not tenant-specific)
  TENANT_ADMIN     // Tenant owner
  ORG_ADMIN        // Organisation admin
  HR_MANAGER       // HR with full module access
  MANAGER          // Team manager
  EMPLOYEE         // Regular employee
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

// ============================================
// RBAC - Permissions
// ============================================
model Permission {
  id          String   @id @default(uuid())
  module      Module
  action      Action
  description String?
  createdAt   DateTime @default(now())

  rolePermissions RolePermission[]

  @@unique([module, action])
  @@map("permissions")
}

enum Module {
  DASHBOARD
  EMPLOYEES
  DEPARTMENTS
  ATTENDANCE
  LEAVE
  PAYROLL
  PERFORMANCE
  RECRUITMENT
  REPORTS
  SETTINGS
  ORGANISATION
  TENANT_MANAGEMENT
}

enum Action {
  VIEW
  CREATE
  UPDATE
  DELETE
  APPROVE
  EXPORT
  MANAGE
}

model RolePermission {
  id           String     @id @default(uuid())
  role         UserRole
  permissionId String
  createdAt    DateTime   @default(now())

  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([role, permissionId])
  @@map("role_permissions")
}

// ============================================
// EMPLOYEE MANAGEMENT
// ============================================
model Employee {
  id              String   @id @default(uuid())
  userId          String   @unique
  organisationId  String
  employeeCode    String   // EMP001, EMP002
  firstName       String
  lastName        String
  middleName      String?
  email           String
  phone           String?
  dateOfBirth     DateTime?
  gender          Gender?
  maritalStatus   MaritalStatus?
  bloodGroup      String?
  
  // Employment Details
  dateOfJoining   DateTime
  designationId   String?
  departmentId    String?
  reportingTo     String?  // Employee ID of manager
  employmentType  EmploymentType @default(FULL_TIME)
  status          EmployeeStatus @default(ACTIVE)
  
  // Address
  currentAddress  String?
  permanentAddress String?
  city            String?
  state           String?
  country         String?
  zipCode         String?
  
  // Documents
  profilePicture  String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organisation    Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  designation     Designation? @relation(fields: [designationId], references: [id])
  department      Department?  @relation(fields: [departmentId], references: [id])
  manager         Employee?    @relation("EmployeeReporting", fields: [reportingTo], references: [id])
  subordinates    Employee[]   @relation("EmployeeReporting")

  @@unique([organisationId, employeeCode])
  @@map("employees")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum MaritalStatus {
  SINGLE
  MARRIED
  DIVORCED
  WIDOWED
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERN
  CONSULTANT
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
  ON_LEAVE
  TERMINATED
  RESIGNED
}

// ============================================
// DEPARTMENT & DESIGNATION
// ============================================
model Department {
  id              String   @id @default(uuid())
  organisationId  String
  name            String
  code            String   // HR, IT, SALES
  description     String?
  headOfDepartment String? // Employee ID
  status          DeptStatus @default(ACTIVE)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  organisation    Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  employees       Employee[]
  designations    Designation[]

  @@unique([organisationId, code])
  @@map("departments")
}

enum DeptStatus {
  ACTIVE
  INACTIVE
}

model Designation {
  id             String   @id @default(uuid())
  departmentId   String
  name           String
  code           String   // MGR, SR_DEV, JR_DEV
  level          Int      @default(1) // Hierarchy level
  description    String?
  status         DesignationStatus @default(ACTIVE)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  department     Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  employees      Employee[]

  @@unique([departmentId, code])
  @@map("designations")
}

enum DesignationStatus {
  ACTIVE
  INACTIVE
}

// ============================================
// AUDIT LOGS
// ============================================
model AuditLog {
  id         String   @id @default(uuid())
  tenantId   String
  userId     String?
  action     String   // LOGIN, CREATE_EMPLOYEE, UPDATE_SALARY, etc.
  entity     String?  // Employee, Department, etc.
  entityId   String?
  changes    Json?    // Store before/after values
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([tenantId, createdAt])
  @@map("audit_logs")
}