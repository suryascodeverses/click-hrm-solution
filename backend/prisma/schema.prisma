generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// SUPER ADMIN (App-level admin)
// ============================================
model SuperAdmin {
  id            String   @id @default(uuid())
  email         String   @unique
  password      String
  name          String
  isActive      Boolean  @default(true)
  lastLogin     DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  refreshTokens SuperAdminRefreshToken[]

  @@map("super_admins")
}

model SuperAdminRefreshToken {
  id           String      @id @default(uuid())
  superAdminId String
  token        String      @unique
  expiresAt    DateTime
  createdAt    DateTime    @default(now())

  superAdmin   SuperAdmin  @relation(fields: [superAdminId], references: [id], onDelete: Cascade)

  @@map("super_admin_refresh_tokens")
}

// ============================================
// MULTI-TENANCY CORE
// ============================================
model Tenant {
  id             String   @id @default(uuid())
  name           String
  subdomain      String   @unique // e.g., "acme" for acme.yourdomain.com
  email          String
  phone          String?
  logo           String?
  status         TenantStatus @default(ACTIVE)
  subscriptionTier String  @default("FREE") // FREE, BASIC, PREMIUM, ENTERPRISE
  maxEmployees   Int      @default(10)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organisations  Organisation[]
  users          User[]
  subscription    Subscription?

  @@map("tenants")
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  INACTIVE
}

// ============================================
// ORGANISATION (Tenant can have multiple orgs)
// ============================================
model Organisation {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  code        String   // Unique org code like "HQ", "BRANCH1"
  address     String?
  city        String?
  state       String?
  country     String?
  zipCode     String?
  phone       String?
  email       String?
  logo        String?
  status      OrgStatus @default(ACTIVE)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employees   Employee[]
  departments Department[]

  @@unique([tenantId, code])
  @@map("organisations")
}

enum OrgStatus {
  ACTIVE
  INACTIVE
}

// ============================================
// USER AUTHENTICATION & RBAC
// ============================================
model User {
  id              String   @id @default(uuid())
  tenantId        String
  email           String   
  password        String
  role            UserRole @default(EMPLOYEE)
  isActive        Boolean  @default(true)
  lastLogin       DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employee        Employee?
  refreshTokens   RefreshToken[]

  @@unique([tenantId, email])
  @@map("users")
}

enum UserRole {
  SUPER_ADMIN      // App-level admin (not tenant-specific)
  TENANT_ADMIN     // Tenant owner
  ORG_ADMIN        // Organisation admin
  HR_MANAGER       // HR with full module access
  MANAGER          // Team manager
  EMPLOYEE         // Regular employee
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

// ============================================
// RBAC - Permissions
// ============================================
model Permission {
  id          String   @id @default(uuid())
  module      Module
  action      Action
  description String?
  createdAt   DateTime @default(now())

  rolePermissions RolePermission[]

  @@unique([module, action])
  @@map("permissions")
}

enum Module {
  DASHBOARD
  EMPLOYEES
  DEPARTMENTS
  ATTENDANCE
  LEAVE
  PAYROLL
  PERFORMANCE
  RECRUITMENT
  REPORTS
  SETTINGS
  ORGANISATION
  TENANT_MANAGEMENT
}

enum Action {
  VIEW
  CREATE
  UPDATE
  DELETE
  APPROVE
  EXPORT
  MANAGE
}

model RolePermission {
  id           String     @id @default(uuid())
  role         UserRole
  permissionId String
  createdAt    DateTime   @default(now())

  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([role, permissionId])
  @@map("role_permissions")
}

// ============================================
// EMPLOYEE MANAGEMENT
// ============================================
model Employee {
  id              String   @id @default(uuid())
  userId          String   @unique
  organisationId  String
  employeeCode    String   // EMP001, EMP002
  firstName       String
  lastName        String
  middleName      String?
  email           String
  phone           String?
  dateOfBirth     DateTime?
  gender          Gender?
  maritalStatus   MaritalStatus?
  bloodGroup      String?
  
  // Employment Details
  dateOfJoining   DateTime
  designationId   String?
  departmentId    String?
  reportingTo     String?  // Employee ID of manager
  employmentType  EmploymentType @default(FULL_TIME)
  status          EmployeeStatus @default(ACTIVE)
  
  // Address
  currentAddress  String?
  permanentAddress String?
  city            String?
  state           String?
  country         String?
  zipCode         String?
  
  // Documents
  profilePicture  String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organisation    Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  designation     Designation? @relation(fields: [designationId], references: [id])
  department      Department?  @relation(fields: [departmentId], references: [id])
  manager         Employee?    @relation("EmployeeReporting", fields: [reportingTo], references: [id])
  subordinates    Employee[]   @relation("EmployeeReporting")
  attendances     Attendance[]
  leaves          Leave[]
  leaveBalances   LeaveBalance[]
  approvedLeaves  Leave[]      @relation("LeaveApprover")
  salaryStructure SalaryStructure?
  payslips        Payslip[]

  @@unique([organisationId, employeeCode])
  @@map("employees")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum MaritalStatus {
  SINGLE
  MARRIED
  DIVORCED
  WIDOWED
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERN
  CONSULTANT
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
  ON_LEAVE
  TERMINATED
  RESIGNED
}

// ============================================
// DEPARTMENT & DESIGNATION
// ============================================
model Department {
  id              String   @id @default(uuid())
  organisationId  String
  name            String
  code            String   // HR, IT, SALES
  description     String?
  headOfDepartment String? // Employee ID
  status          DeptStatus @default(ACTIVE)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  organisation    Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  employees       Employee[]
  designations    Designation[]

  @@unique([organisationId, code])
  @@map("departments")
}

enum DeptStatus {
  ACTIVE
  INACTIVE
}

model Designation {
  id             String   @id @default(uuid())
  departmentId   String
  name           String
  code           String   // MGR, SR_DEV, JR_DEV
  level          Int      @default(1) // Hierarchy level
  description    String?
  status         DesignationStatus @default(ACTIVE)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  department     Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  employees      Employee[]

  @@unique([departmentId, code])
  @@map("designations")
}

enum DesignationStatus {
  ACTIVE
  INACTIVE
}

// ============================================
// AUDIT LOGS (ENHANCED)
// ============================================
model AuditLog {
  id         String   @id @default(uuid())
  tenantId   String?  // Null for super admin actions
  userId     String?
  userEmail  String?  // Store email for reference
  userName   String?  // Store name for reference
  action     AuditAction
  entity     String?  // Employee, Department, Tenant, User, etc.
  entityId   String?
  description String? // Human-readable description
  changes    Json?    // Store before/after values
  metadata   Json?    // Additional context (IP, user agent, etc.)
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([tenantId, createdAt])
  @@index([userId, createdAt])
  @@index([action, createdAt])
  @@index([entity, createdAt])
  @@map("audit_logs")
}

enum AuditAction {
  // Authentication
  LOGIN
  LOGOUT
  LOGIN_FAILED
  REFRESH_TOKEN
  
  // Super Admin
  SUPER_ADMIN_LOGIN
  TENANT_CREATED
  TENANT_UPDATED
  TENANT_DELETED
  TENANT_SUSPENDED
  TENANT_ACTIVATED
  
  // User Management
  USER_CREATED
  USER_UPDATED
  USER_DELETED
  USER_ACTIVATED
  USER_DEACTIVATED
  ROLE_CHANGED
  
  // Employee Management
  EMPLOYEE_CREATED
  EMPLOYEE_UPDATED
  EMPLOYEE_DELETED
  EMPLOYEE_STATUS_CHANGED
  
  // Organisation
  ORGANISATION_CREATED
  ORGANISATION_UPDATED
  ORGANISATION_DELETED
  
  // Department
  DEPARTMENT_CREATED
  DEPARTMENT_UPDATED
  DEPARTMENT_DELETED
  
  // Attendance
  ATTENDANCE_MARKED
  ATTENDANCE_UPDATED
  
  // Leave
  LEAVE_APPLIED
  LEAVE_APPROVED
  LEAVE_REJECTED
  LEAVE_CANCELLED
  
  // Payroll
  SALARY_STRUCTURE_CREATED
  SALARY_STRUCTURE_UPDATED
  PAYSLIP_GENERATED
  PAYSLIP_PROCESSED
  
  // Settings
  SETTINGS_UPDATED
  
  // Other
  DATA_EXPORTED
  BULK_OPERATION
}

// ============================================
// ATTENDANCE MODULE
// ============================================
model Attendance {
  id           String    @id @default(uuid())
  employeeId   String
  date         DateTime  @db.Date
  checkIn      DateTime?
  checkOut     DateTime?
  status       AttendanceStatus @default(ABSENT)
  workHours    Float?    // Calculated in hours
  lateBy       Int?      // Minutes late
  earlyLeave   Int?      // Minutes early leave
  remarks      String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  employee     Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, date])
  @@index([employeeId, date])
  @@map("attendances")
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  HALF_DAY
  LATE
  ON_LEAVE
  HOLIDAY
  WEEKEND
}

// ============================================
// LEAVE MANAGEMENT
// ============================================
model LeaveType {
  id              String   @id @default(uuid())
  tenantId        String
  name            String   // Casual, Sick, Earned, etc.
  code            String   // CL, SL, EL
  defaultDays     Int      // Default annual allocation
  carryForward    Boolean  @default(false)
  maxCarryForward Int?
  requiresApproval Boolean @default(true)
  color           String?  // For UI display
  description     String?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  leaves          Leave[]
  balances        LeaveBalance[]

  @@unique([tenantId, code])
  @@map("leave_types")
}

model LeaveBalance {
  id           String   @id @default(uuid())
  employeeId   String
  leaveTypeId  String
  year         Int
  totalDays    Float
  usedDays     Float    @default(0)
  pendingDays  Float    @default(0)
  availableDays Float   // Computed: totalDays - usedDays - pendingDays
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  employee     Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  leaveType    LeaveType @relation(fields: [leaveTypeId], references: [id])

  @@unique([employeeId, leaveTypeId, year])
  @@map("leave_balances")
}

model Leave {
  id              String      @id @default(uuid())
  employeeId      String
  leaveTypeId     String
  startDate       DateTime    @db.Date
  endDate         DateTime    @db.Date
  days            Float       // Can be 0.5 for half day
  reason          String
  status          LeaveStatus @default(PENDING)
  appliedAt       DateTime    @default(now())
  approvedBy      String?
  approvedAt      DateTime?
  rejectedReason  String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  employee        Employee    @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  leaveType       LeaveType   @relation(fields: [leaveTypeId], references: [id])
  approver        Employee?   @relation("LeaveApprover", fields: [approvedBy], references: [id])

  @@index([employeeId, status])
  @@index([status, appliedAt])
  @@map("leaves")
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

// ============================================
// PAYROLL MANAGEMENT
// ============================================
model SalaryStructure {
  id              String   @id @default(uuid())
  employeeId      String   @unique
  basicSalary     Decimal  @db.Decimal(10, 2)
  hra             Decimal  @db.Decimal(10, 2) // House Rent Allowance
  conveyance      Decimal  @db.Decimal(10, 2)
  medical         Decimal  @db.Decimal(10, 2)
  specialAllowance Decimal @db.Decimal(10, 2)
  ctc             Decimal  @db.Decimal(10, 2) // Cost to Company
  effectiveFrom   DateTime @db.Date
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  employee        Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  payslips        Payslip[]

  @@map("salary_structures")
}

model Payslip {
  id                String   @id @default(uuid())
  employeeId        String
  salaryStructureId String
  month             Int      // 1-12
  year              Int
  workingDays       Int
  presentDays       Int
  absentDays        Int
  leaveDays         Int
  
  // Earnings
  basicPay          Decimal  @db.Decimal(10, 2)
  hra               Decimal  @db.Decimal(10, 2)
  conveyance        Decimal  @db.Decimal(10, 2)
  medical           Decimal  @db.Decimal(10, 2)
  specialAllowance  Decimal  @db.Decimal(10, 2)
  bonus             Decimal  @db.Decimal(10, 2) @default(0)
  totalEarnings     Decimal  @db.Decimal(10, 2)
  
  // Deductions
  providentFund     Decimal  @db.Decimal(10, 2) @default(0)
  professionalTax   Decimal  @db.Decimal(10, 2) @default(0)
  incomeTax         Decimal  @db.Decimal(10, 2) @default(0)
  otherDeductions   Decimal  @db.Decimal(10, 2) @default(0)
  totalDeductions   Decimal  @db.Decimal(10, 2)
  
  netPay            Decimal  @db.Decimal(10, 2)
  status            PayslipStatus @default(DRAFT)
  paidOn            DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  employee          Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  salaryStructure   SalaryStructure @relation(fields: [salaryStructureId], references: [id])

  @@unique([employeeId, month, year])
  @@index([employeeId, year, month])
  @@map("payslips")
}

enum PayslipStatus {
  DRAFT
  PROCESSED
  PAID
}

// ============================================
// BILLING & SUBSCRIPTIONS
// ============================================

model SubscriptionPlan {
  id              String   @id @default(uuid())
  name            String   // FREE, BASIC, PREMIUM, ENTERPRISE
  displayName     String   // "Free Plan", "Basic Plan", etc.
  price           Decimal  @db.Decimal(10, 2) // Monthly price
  yearlyPrice     Decimal? @db.Decimal(10, 2) // Yearly price (optional)
  maxEmployees    Int
  maxOrganisations Int
  features        Json     // Array of features
  isActive        Boolean  @default(true)
  stripePriceId   String?  // For Stripe integration
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  subscriptions   Subscription[]

  @@unique([name])
  @@map("subscription_plans")
}

model Subscription {
  id                String             @id @default(uuid())
  tenantId          String             @unique
  planId            String
  status            SubscriptionStatus @default(TRIAL)
  billingCycle      BillingCycle       @default(MONTHLY)
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean           @default(false)
  trialEndsAt       DateTime?
  stripeCustomerId  String?
  stripeSubscriptionId String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  tenant            Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan              SubscriptionPlan   @relation(fields: [planId], references: [id])
  invoices          Invoice[]
  payments          Payment[]

  @@map("subscriptions")
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELLED
  EXPIRED
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

model Invoice {
  id              String        @id @default(uuid())
  subscriptionId  String
  tenantId        String
  invoiceNumber   String        @unique // INV-2024-0001
  amount          Decimal       @db.Decimal(10, 2)
  tax             Decimal       @db.Decimal(10, 2) @default(0)
  total           Decimal       @db.Decimal(10, 2)
  status          InvoiceStatus @default(PENDING)
  dueDate         DateTime
  paidAt          DateTime?
  stripeInvoiceId String?
  downloadUrl     String?
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  subscription    Subscription  @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  payments        Payment[]

  @@index([tenantId, createdAt])
  @@map("invoices")
}

enum InvoiceStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
  REFUNDED
}

model Payment {
  id              String        @id @default(uuid())
  subscriptionId  String
  invoiceId       String?
  tenantId        String
  amount          Decimal       @db.Decimal(10, 2)
  currency        String        @default("USD")
  paymentMethod   PaymentMethod
  status          PaymentStatus
  transactionId   String?       // External payment gateway transaction ID
  stripePaymentId String?
  metadata        Json?
  paidAt          DateTime?
  createdAt       DateTime      @default(now())

  subscription    Subscription  @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  invoice         Invoice?      @relation(fields: [invoiceId], references: [id])

  @@index([tenantId, createdAt])
  @@map("payments")
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  BANK_TRANSFER
  PAYPAL
  STRIPE
  MANUAL
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  REFUNDED
}

// ============================================
// EMAIL TEMPLATES
// ============================================

model EmailTemplate {
  id          String              @id @default(uuid())
  name        String              @unique // welcome_email, invoice_email, etc.
  displayName String
  category    EmailCategory
  subject     String
  htmlContent String              @db.Text
  textContent String?             @db.Text
  variables   Json                // Available variables for template
  isActive    Boolean             @default(true)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  logs        EmailLog[]

  @@map("email_templates")
}

enum EmailCategory {
  AUTHENTICATION
  BILLING
  NOTIFICATIONS
  SYSTEM
  MARKETING
}

model EmailLog {
  id           String      @id @default(uuid())
  templateId   String?
  tenantId     String?
  recipient    String
  subject      String
  status       EmailStatus @default(PENDING)
  sentAt       DateTime?
  failedAt     DateTime?
  errorMessage String?
  metadata     Json?
  createdAt    DateTime    @default(now())

  template     EmailTemplate? @relation(fields: [templateId], references: [id])

  @@index([tenantId, createdAt])
  @@index([status, createdAt])
  @@map("email_logs")
}

enum EmailStatus {
  PENDING
  SENT
  FAILED
  BOUNCED
}

// ============================================
// SYSTEM MONITORING
// ============================================

model SystemMetric {
  id          String     @id @default(uuid())
  metricType  MetricType
  value       Float
  unit        String     // MB, %, ms, count, etc.
  metadata    Json?
  recordedAt  DateTime   @default(now())

  @@index([metricType, recordedAt])
  @@map("system_metrics")
}

enum MetricType {
  CPU_USAGE
  MEMORY_USAGE
  DISK_USAGE
  DATABASE_SIZE
  RESPONSE_TIME
  ERROR_RATE
  ACTIVE_USERS
  API_CALLS
  QUEUE_SIZE
}

model SystemAlert {
  id          String      @id @default(uuid())
  alertType   AlertType
  severity    AlertSeverity
  title       String
  message     String      @db.Text
  isResolved  Boolean     @default(false)
  resolvedAt  DateTime?
  metadata    Json?
  createdAt   DateTime    @default(now())

  @@index([severity, isResolved, createdAt])
  @@map("system_alerts")
}

enum AlertType {
  PERFORMANCE
  ERROR
  SECURITY
  CAPACITY
  BILLING
}

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// ============================================
// UPDATE TENANT MODEL - Add subscription relation
// ============================================
// Add this field to your existing Tenant model:
// subscription    Subscription?  